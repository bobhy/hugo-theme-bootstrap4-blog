{{/* idea from https://alexlakatos.com/web/2020/07/17/hugo-image-processing/ and https://laurakalbag.com/processing-responsive-images-with-hugo/, converted into partial (and shortcode) */}}
{{/* call partial with (dict 'page' . 'img' _local_path_ 'alt' "text" ) */}}
{{- $p := . -}}
{{- $src := . -}}
{{- with (.Scratch.Get "img") -}}
  {{- with ($p.Resources.GetMatch .) -}}
    {{- $src = . -}}
    {{- /* set image sizes, these are hardcoded for now */ -}}
    {{- $tinyw := default "500x" -}}
    {{- $smallw := default "800x" -}}
    {{- $mediumw := default "1200x" -}}
    {{- $tiny := ($src.Resize $tinyw) -}}
    {{- $small := ($src.Resize $smallw) -}}
    {{- $medium := ($src.Resize $mediumw) -}}
    {{- /* only use images smaller than or equal to the src (original) image size */ -}}
    {{- /* bugbug image is always resized, but might not be referenced in srcset */ -}}
    <img
    sizes="(min-width: 35em) 720px, 100vw"
    srcset='
    {{ if ge $src.Width "500" }}
        {{ with $tiny.RelPermalink }}{{.}} 500w{{ end }}
    {{ end }}
    {{ if ge $src.Width "800" }}
        {{ with $small.RelPermalink }}, {{.}} 800w{{ end }}
    {{ end }}
    {{ if ge $src.Width "1200" }}
        {{ with $medium.RelPermalink }}, {{.}} 1200w{{ end }}
    {{ end }}'
    {{- if $medium }} src="{{ $medium.RelPermalink }}"{{ else }} src="{{ $src.RelPermalink }}"{{ end -}}
    {{- with $p.Scratch.Get "alt" }} alt="{{.}}"{{ else }} alt=""{{ end -}}>
  {{- end -}}
{{- end -}}

